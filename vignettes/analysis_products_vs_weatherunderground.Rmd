---
title: "Difference calculation between products and weatherunderground"
output: html_document
date: "2024-05-14"
---

## Configuration

```{r}
gridmet_dir <- "../input/gridmet/"
daymet_dir <- "../input/daymet/north_america/"
wu_dir <- "../input/cws/"
ts = as.POSIXct("2021-06-01 00:00:00", tz = "UTC")
te = as.POSIXct("2021-08-31 23:59:59", tz = "UTC")
dates <- seq(ts, te, by = "1 day")
nc_shp <- terra::vect("../input/NC_county_boundary/North_Carolina_State_and_County_Boundary_Polygons.shp")
```

## Data

Open daymet on NC for study period

```{r}
dm_tmin <- load_daymet(dates, nc_shp, "tmin", daymet_dir) 
dm_tmax <- load_daymet(dates, nc_shp, "tmax", daymet_dir) 
terra::plot(dm_tmin[[time(dm_tmin) == dates[1]]])
```

Open gridmet on NC for study period

```{r}
gm_tmmn <- load_gridmet(dates, nc_shp, "tmmn", gridmet_dir) |>
        convert_temp(from = "K", to = "C")
gm_tmmx <- load_gridmet(dates, nc_shp, "tmmx", gridmet_dir)|>
        convert_temp(from = "K", to = "C")
terra::plot(gm_tmmn[[time(gm_tmmn) == dates[1]]])
```

Open processed WeatherUnderground on NC for study period

```{r, eval = FALSE}
files <- list.files(path = wu_dir,
                    pattern = "wu_nc_cleaned_and_calibrated_*",
                    full.names = TRUE)
wu_list <- lapply(files, FUN = function(x) { readRDS(x)$obs })
wu <- do.call("rbind", wu_list)
rm(wu_list)
```

Transform to TN and TX dataframe

```{r, eval = FALSE}
summarize_daily_temp <- function(x) {
  # todoo extract time of tn and time of tx for each station
  daily_tn_tx <- x 
  daily_tn_tx$date <- lubridate::date(daily_tn_tx$time)
  daily_tn_tx <- daily_tn_tx |>
    dplyr::group_by(site_id, date) |>
    dplyr::summarise(tn = min(temp_cal, na.rm = TRUE),
                     tx = max(temp_cal, na.rm = TRUE)) |>
    dplyr::ungroup() |>
    as.data.frame()
  # remove duplicates
  daily_tn_tx <- unique(daily_tn_tx)
  return(daily_tn_tx)
}

wu_day <- summarize_daily_temp(wu)
wu_day <- sf::st_as_sf(wu_day, crs = "epsg:4326")
saveRDS(wu_day, paste0(wu_dir, "wu_nc_daily_jja2021.rds"))
```

```{r}
wu_day <- readRDS(paste0(wu_dir, "wu_nc_daily_jja2021.rds"))
```

## Maps

Map WU and heatwatch on the Triangle

```{r}

```

Map WU above gridmet and daymet on NC

```{r}
for (i in 1:length(dates)) {
  date <- dates[i]
  plots <- map_wu_product_date(wu_day,
                               dm_tmin,
                               dm_tmax,
                               gm_tmmn,
                               gm_tmmx,
                               nc_shp,
                               date)
  ggsave(paste0("../output/nc_products_vs_wu/map_", date, ".png"),
        plot = plots$p,
        bg = "white",
        width = 20,
        height = 8,
        dpi = 300)
}
```

## Quantitative analysis

Compute difference between products and processed WeatherUnderground

```{r}
wu <- wu_day 

## debut fonction
v <- terra::vect(wu)
bufs_pol <- terra::buffer(v, width = 100) |>
   sf::st_as_sf()
list_sf <- lapply(dates, FUN = function(x) {
  v_date <- v[which(v$date == x), ]
  v_date$dm_tmin <- exactextractr::exact_extract(x = dm_tmin[[time(dm_tmin) == x]],
                               y = sf::st_geometry(bufs_pol[which(bufs_pol$date == x), ]),
                               fun = "mode")
  v_date$dm_tmax <- exactextractr::exact_extract(x = dm_tmax[[time(dm_tmax) == x]],
                               y = sf::st_geometry(bufs_pol[which(bufs_pol$date == x), ]),
                               fun = "mode")
  v_date$gm_tmmn <- exactextractr::exact_extract(x = gm_tmmn[[time(gm_tmmn) == x]],
                               y = sf::st_geometry(bufs_pol[which(bufs_pol$date == x), ]),
                               fun = "mode")
  v_date$gm_tmmx <- exactextractr::exact_extract(x = gm_tmmx[[time(gm_tmmx) == x]],
                               y = sf::st_geometry(bufs_pol[which(bufs_pol$date == x), ]),
                               fun = "mode")
  return(v_date)
  } 
)

wu <- do.call("rbind", list_sf)
wu$delta_dm_tn <- wu$dm_tmin - wu$tn
wu$delta_gm_tn <- wu$gm_tmmn - wu$tn
wu$delta_dm_tx <- wu$dm_tmax - wu$tx
wu$delta_gm_tx <- wu$gm_tmmx - wu$tx


```

#### Add imperviousness, NLCD and population density

Imperviousness

```{r}
imp <- terra::rast("../input/US_2019_imperviousness/nlcd_2019_impervious_l48_20210604.img")
bufs_pol <- terra::buffer(wu, width = 400) |>
    terra::project(terra::crs(imp)) |>
    sf::st_as_sf()
wu$imp <- exactextractr::exact_extract(x = imp,
                                       y = sf::st_geometry(bufs_pol),
                                       fun = "median")
```

NLCD

```{r}
nlcd <- terra::rast("../input/nlcd_2021_land_cover_l48_20230630/nlcd_2021_land_cover_l48_20230630.img")
bufs_pol <- terra::buffer(wu, width = 400) |>
    terra::project(terra::crs(nlcd)) |>
    sf::st_as_sf()
wu$nlcd <- exactextractr::exact_extract(x = nlcd,
                                        y = sf::st_geometry(bufs_pol),
                                        fun = "mode")
```

Population density

```{r}
pop <- terra::rast("../input/gpw-v4-population-density-adjusted-to-2015-unwpp-country-totals-rev11_2020_30_sec_tif/gpw_v4_population_density_adjusted_to_2015_unwpp_country_totals_rev11_2020_30_sec.tif")
bufs_pol <- terra::buffer(wu, width = 400) |>
    terra::project(terra::crs(pop)) |>
    sf::st_as_sf()
wu$pop <- exactextractr::exact_extract(x = pop,
                                        y = sf::st_geometry(bufs_pol),
                                        fun = "mode")
```

## Analysis

```{r}
p_dm_tn <- ggplot(wu, aes(x = date, y = delta_dm_tn)) +
  geom_point(alpha = .01) +
  ylim(-10, 10) +
  geom_hline(yintercept = 0, color = "red")

p_dm_tx <- ggplot(wu, aes(x = date, y = delta_dm_tx)) +
  geom_point(alpha = .01) +
  ylim(-10, 10) +
  geom_hline(yintercept = 0, color = "red")

p_gm_tn <- ggplot(wu, aes(x = date, y = delta_gm_tn)) +
  geom_point(alpha = .01) +
  ylim(-10, 10) +
  geom_hline(yintercept = 0, color = "red")

p_gm_tx <- ggplot(wu, aes(x = date, y = delta_gm_tx)) +
  geom_point(alpha = .01) +
  ylim(-10, 10) +
  geom_hline(yintercept = 0, color = "red")

ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, nrow = 2, ncol = 2)
```

Plot difference per NLCD

```{r}
nlcd_classes <- list(
    value = c(
      11, 21, 22, 23, 24, 31, 41, 42, 43, 52,
      71, 81, 82, 90, 95
    ),
    class = c(
      "WTR", "OSD", "LID", "MID", "HID",
      "BRN", "DFO", "EFO", "MFO", "SHB",
      "GRS", "PAS", "CRP", "WDW", "EHW"
    ),
    names = c(
      "Open Water",
      "Developed, Open Space",
      "Developed, Low Intensity",
      "Developed, Medium Intensity",
      "Developed, High Intensity",
      "Barren Land",
      "Deciduous Forest",
      "Evergreen Forest",
      "Mixed Forest",
      "Shrub/Scrub",
      "Herbaceous",
      "Hay/Pasture",
      "Cultivated Crops",
      "Woody Wetlands",
      "Emergent Herbaceous Wetlands"
    ),
    col = c(
      "#476ba1", "#decaca", "#d99482", "#ee0000",
      "#ab0000", "#b3aea3", "#68ab63", "#1c6330",
      "#b5ca8f", "#ccba7d", "#e3e3c2", "#dcd93d",
      "#ab7028", "#bad9eb", "#70a3ba"
    )
  )
  nlcd_classes <- as.data.frame(nlcd_classes)
  val <- nlcd_classes$col
  names(val) <- as.factor(nlcd_classes$value)
  lab <- nlcd_classes$names
  names(lab) <- as.factor(nlcd_classes$value)

  # bpxplots
  p_dm_tn <- ggplot(wu,
         aes(x = as.factor(nlcd),
             y = delta_dm_tn,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and Daymet')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
  p_gm_tn <- ggplot(wu,
         aes(x = as.factor(nlcd),
             y = delta_gm_tn,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and GridMET')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
  # bpxplots
  p_dm_tx <- ggplot(wu,
         aes(x = as.factor(nlcd),
             y = delta_dm_tx,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TX_{dm}-TX_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and Daymet')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
  p_gm_tx <- ggplot(wu,
         aes(x = as.factor(nlcd),
             y = delta_gm_tx,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TX_{dm}-TX_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and GridMET')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
  
p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, ncol = 2, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/boxplot_nlcd_delta_tn_wu_vs_products.png",
       bg = "white",
       height = 6,
       width = 12,
       dpi = 300)

p <- ggpubr::ggarrange(p_dm_tx, p_gm_tx, ncol = 2, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/boxplot_nlcd_delta_tx_wu_vs_products.png",
       bg = "white",
       height = 6,
       width = 12,
       dpi = 300)


p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, ncol = 4, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/boxplot_nlcd_delta_wu_vs_products.png",
       bg = "white",
       height = 6,
       width = 16,
       dpi = 300)

```

![](http://127.0.0.1:45109/chunk_output/C71639B01b7b2721/46E4361C/cb9f6l7xe5ye7/000014.png)

Plot difference per imperviousness\

```{r}
p_dm_tn <- ggplot(wu, aes(x = imp, y = delta_dm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylim(-10, 10) +
  ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_dm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = imp, y = delta_dm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{dm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tn <- ggplot(wu, aes(x = imp, y = delta_gm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TN_{gm}-TN_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = imp, y = delta_gm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{gm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, nrow = 2, ncol = 2)
```

```{r}
p_dm_tn <- ggplot(wu, aes(x = tn, y = delta_dm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylim(-10, 10) +
  ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_dm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = tx, y = delta_dm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{dm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tn <- ggplot(wu, aes(x = tn, y = delta_gm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TN_{gm}-TN_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = tx, y = delta_gm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{gm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, nrow = 2, ncol = 2)
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/scatterplot_delta_wu_vs_products.png",
       bg = "white",
       height = 6,
       width = 16,
       dpi = 300)
```

Plot difference per population density

```{r}
p_dm_tn <- ggplot(wu, aes(x = pop, y = delta_dm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylim(-10, 10) +
  ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_dm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = pop, y = delta_dm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{dm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tn <- ggplot(wu, aes(x = pop, y = delta_gm_tn, color = tn)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TN_{gm}-TN_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

p_gm_tx <- ggplot(wu[which(wu$tx < 45), ], aes(x = pop, y = delta_gm_tx, color = tx)) +
  geom_point(shape = 16) +
  ylab(latex2exp::TeX("$TX_{gm}-TX_{WU}$ (°C)")) +
  ylim(-10, 10) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    ) + 
  geom_hline(yintercept = 0, color = "red")

ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, nrow = 2, ncol = 2)
```

#### Focus on very hot nights

TN_avg \> 20 degrees celcius

TODOOOO look what is the 90th percentile in NC

Extract average temperature across NC

```{r}
rmse <- function(x) {
  1/length(x) * sum(x ** 2)
}
nc_daily <- wu |>
    dplyr::group_by(date) |>
    dplyr::summarise(tn = median(tn, na.rm = TRUE),
                     tx = median(tx, na.rm = TRUE), 
                     delta_dm_tn = rmse(delta_dm_tn),
                     delta_dm_tx = rmse(delta_dm_tx),
                     delta_gm_tn = rmse(delta_gm_tn),
                     delta_gm_tx = rmse(delta_gm_tx)) |>
    dplyr::ungroup() |>
    as.data.frame()
# remove duplicates
nc_daily <- unique(nc_daily)
```

```{r}
nrow(nc_daily)
head(nc_daily)
ggplot(nc_daily, aes(date, tn)) +
  geom_line() +
  geom_hline(yintercept = 22, color = "red")

ggplot(nc_daily, aes(date, tx)) +
  geom_line() +
  geom_hline(yintercept = 31, color = "red")
```

```{r}
ggplot(nc_daily, aes(tn, delta_dm_tn)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red")
ggplot(nc_daily, aes(tx, delta_dm_tx)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red")
ggplot(nc_daily, aes(tn, delta_gm_tn)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red")
ggplot(nc_daily, aes(tx, delta_gm_tx)) +
  geom_point() +
  geom_hline(yintercept = 0, color = "red")
```

```{r}
hot_tn_dates <- nc_daily[which(nc_daily$tn >= 22), "date"]
wu_hot_tn <- wu[which(wu$date %in% hot_tn_dates), ]
```

```{r}
p_dm_tn <- ggplot(wu_hot_tn,
         aes(x = as.factor(nlcd),
             y = delta_dm_tn,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and Daymet')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
  p_gm_tn <- ggplot(wu_hot_tn,
         aes(x = as.factor(nlcd),
             y = delta_gm_tn,
             group = as.factor(nlcd),
             fill = as.factor(nlcd))) +
    geom_hline(yintercept = 0, color = "red") +
    geom_hline(yintercept = -2, color = "blue") +
    geom_boxplot() +
    xlab("NLCD") +
    ylab(latex2exp::TeX("$TN_{dm}-TN_{WU}$ (°C)")) +
    labs(
      caption = expression(
        italic('Data sources: WeatherUnderground and GridMET')),
      fill = "NLCD classes") +
    scale_y_continuous(breaks = seq(-10, 10, 1), limits = c(-10, 10)) +
    scale_fill_manual(values = val, labels = lab) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
  
p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, ncol = 2, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/boxplot_nlcd_delta_tn_hotnights_wu_vs_products.png",
       bg = "white",
       height = 6,
       width = 12,
       dpi = 300)
```

Map RMSE per station

```{r}
rmse <- function(x) {
  1/length(x) * sum(x ** 2)
}
wu_rmse <- wu |>
    dplyr::group_by(site_id, nlcd, imp, pop) |>
    dplyr::summarise(rmse_delta_dm_tn = rmse(delta_dm_tn),
                     rmse_delta_dm_tx = rmse(delta_dm_tx),
                     rmse_delta_gm_tn = rmse(delta_gm_tn),
                     rmse_delta_gm_tx = rmse(delta_gm_tx),
                     mederr_delta_dm_tn = median(delta_dm_tn, na.rm = T),
                     mederr_delta_dm_tx = median(delta_dm_tx, na.rm = T),
                     mederr_delta_gm_tn = median(delta_gm_tn, na.rm = T),
                     mederr_delta_gm_tx = median(delta_gm_tx, na.rm = T)) |>
    dplyr::ungroup() |>
    as.data.frame()
```

```{r}
wu_rmse <- merge(wu_rmse, unique(wu_day[, c("site_id", "geometry")]), by = "site_id")
```

```{r}
wu_rmse_plot <- wu_rmse
wu_rmse_plot <- wu_rmse[which(wu_rmse$rmse_delta_dm_tn <= 7), ]
  
p_dm_tn <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = rmse_delta_dm_tn), size = 1) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    )

wu_rmse_plot <- wu_rmse[which(wu_rmse$rmse_delta_gm_tn <= 7), ]

p_gm_tn <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = rmse_delta_gm_tn), size = 1) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    )

wu_rmse_plot <- wu_rmse[which(wu_rmse$rmse_delta_dm_tx <= 7), ]

p_dm_tx <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = rmse_delta_dm_tx), size = 1) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    )

wu_rmse_plot <- wu_rmse[which(wu_rmse$rmse_delta_gm_tx <= 7), ]

p_gm_tx <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = rmse_delta_gm_tx), size = 1) +
  tidyterra::scale_color_whitebox_c(
        palette = "bl_yl_rd",
        n.breaks = 12,
        guide = guide_legend(reverse = TRUE)
    )

p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, ncol = 2, nrow = 2)  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/map_rmse_leq7C.png",
       bg = "white",
       height = 7,
       width = 20,
       dpi = 300)
```

```{r}
wu_rmse_plot <- wu_rmse
  
p_dm_tn <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = mederr_delta_dm_tn), size = 1) +
  labs(title = latex2exp::TeX("$TN_{dm}$"),
       color = "Median error (°C)") +
  scale_color_gradientn(
    colours = c("darkblue", "lightblue", "white", "lightpink", "firebrick3"),
        n.breaks = 12,
        limits = c(-4, 4)
    )


p_gm_tn <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = mederr_delta_gm_tn), size = 1) +
  labs(title = latex2exp::TeX("$TN_{gm}$"),
       color = "Median error (°C)") +
  scale_color_gradientn(
    colours = c("darkblue", "lightblue", "white", "lightpink", "firebrick3"),
        n.breaks = 12,
        limits = c(-4, 4)
    )

p_dm_tx <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = mederr_delta_dm_tx), size = 1) +
  labs(title = latex2exp::TeX("$TX_{dm}$"),
       color = "Median error (°C)") +
  scale_color_gradientn(
    colours = c("darkblue", "lightblue", "white", "lightpink", "firebrick3"),
        n.breaks = 12,
        limits = c(-4, 4)
    )

p_gm_tx <- ggplot(wu_rmse_plot) +
  ggspatial::geom_sf(aes(geometry = geometry, colour = mederr_delta_gm_tx), size = 1) +
  labs(title = latex2exp::TeX("$TX_{gm}$"),
       color = "Median error (°C)") +
  scale_color_gradientn(
    colours = c("darkblue", "lightblue", "white", "lightpink", "firebrick3"),
        n.breaks = 12,
        limits = c(-4, 4)
    )

p <- ggpubr::ggarrange(p_dm_tn,
                       p_gm_tn,
                       p_dm_tx,
                       p_gm_tx,
                       ncol = 2,
                       nrow = 2,
                       common.legend = TRUE,
                       legend = "top")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/map_median_error.png",
       bg = "white",
       height = 6,
       width = 15,
       dpi = 300)
```

```{r}
p_dm_tn <- ggplot(wu_rmse, aes(x = pop, y = delta_dm_tn)) +
  geom_point(shape = 16) +
  xlab("Pop. density") + 
  ylab(latex2exp::TeX("RMSE $TN_{dm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1),
                     limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 5)
    )

p_dm_tn
p_gm_tn <- ggplot(wu_rmse, aes(x = pop, y = delta_gm_tn)) +
  geom_point(shape = 16) +
  xlab("Pop. density") + 
  ylab(latex2exp::TeX("RMSE $TN_{gm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p_dm_tx <- ggplot(wu_rmse, aes(x = pop, y = delta_dm_tx)) +
  geom_point(shape = 16) +
  xlab("Pop. density") + 
  ylab(latex2exp::TeX("RMSE $TX_{dm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p_gm_tx <- ggplot(wu_rmse, aes(x = pop, y = delta_gm_tx)) +
  geom_point(shape = 16) +
  xlab("Pop. density") + 
  ylab(latex2exp::TeX("RMSE $TX_{gm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/scatterplot_rmse_popdensity.png",
       bg = "white",
       height = 6,
       width = 12,
       dpi = 300)
```

```{r}
p_dm_tn <- ggplot(wu_rmse, aes(x = imp, y = delta_dm_tn)) +
  geom_point(shape = 16) +
  xlab("Imperviousness (%)") + 
  ylab(latex2exp::TeX("RMSE $TN_{dm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1),
                     limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 5)
    )

p_dm_tn
p_gm_tn <- ggplot(wu_rmse, aes(x = imp, y = delta_gm_tn)) +
  geom_point(shape = 16) +
  xlab("Imperviousness (%)") + 
  ylab(latex2exp::TeX("RMSE $TN_{gm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p_dm_tx <- ggplot(wu_rmse, aes(x = imp, y = delta_dm_tx)) +
  geom_point(shape = 16) +
  xlab("Imperviousness (%)") + 
  ylab(latex2exp::TeX("RMSE $TX_{dm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p_gm_tx <- ggplot(wu_rmse, aes(x = imp, y = delta_gm_tx)) +
  geom_point(shape = 16) +
  xlab("Imperviousness (%)") + 
  ylab(latex2exp::TeX("RMSE $TX_{gm}$ (°C)")) +
  scale_y_continuous(breaks = seq(0, 15, 1), limits = c(0, 15)) +
  theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey"),
      panel.grid.minor = element_line(linetype = 'dashed', size = 0.5)
    )

p <- ggpubr::ggarrange(p_dm_tn, p_gm_tn, p_dm_tx, p_gm_tx, ncol = 2, nrow = 2, common.legend = TRUE, legend = "right")  
p
ggsave(plot = p,
       file = "../output/nc_products_vs_wu/scatterplot_rmse_imperviousness.png",
       bg = "white",
       height = 6,
       width = 12,
       dpi = 300)
```
