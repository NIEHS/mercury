---
title: "Urban heat island detection in air temperature products"
output: html_document
date: "2024-01-09"
---

```{r}
library(daymetr)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
```

## Useful functions

Subset Raleigh area

```{r}
ral_borders <- terra::vect(paste0("~/Data/Raleigh_City_Council_Districts/",
                                  "Raleigh_City_Council_Districts.shp"))

sp_subset <- function(sp) {
  ext <- terra::vect(paste0("~/Data/Raleigh_City_Council_Districts/",
                                  "Raleigh_City_Council_Districts.shp"))
  ext_proj <- terra::project(ext, terra::crs(sp))
  if (class(sp)[[1]] == "SpatRaster") {
    crop_sp <- terra::crop(sp, ext_proj, mask = TRUE, snap = "out")
  } else {
    crop_sp <- terra::crop(sp, ext_proj, snap = "out")
  }
  return(crop_sp)
}

sp_subset_gridmet <- function(sp) {
  lat <- c(35.7, 35.97, 35.97, 35.7)
  lon <- c(-78.86, -78.86, -78.41, -78.41)
  ext <- terra::vect(cbind(lon, lat),
                     type = "polygons",
                     crs = "EPSG:4326")
  ext_proj <- terra::project(ext, terra::crs(sp))
  if (class(sp)[[1]] == "SpatRaster") {
    crop_sp <- terra::crop(sp, ext_proj, mask = TRUE, snap = "out")
  } else {
    crop_sp <- terra::crop(sp, ext_proj, snap = "out")
  }
  return(crop_sp)
}
```

Temperature degree conversions

```{r}
cel_to_far <- function(x) {
  return((x * 9 / 5) + 32)
}

far_to_cel <- function(x) {
  return((x - 32) * 5 / 9)
}
```

## Daymet

**Download data** Note: location parameter has a unusual format. It is a bounding box c(lat, lon, lat, lon) defined by a top left and bottom-right coordinates.

```{r}
raleigh_lim <- c(35.99,-78.83, 35.7,-78.48)
download_daymet_ncss(location = raleigh_lim,
                     start = 2021,
                     end = 2021,
                     frequency = "daily",
                     param = c("tmin","tmax"),
                     path = tempdir(),
                     silent = TRUE)
```

**Subset Raleigh area on Jul 23rd 2021**

```{r}
daymet <- terra::rast(paste0(tempdir(), "/tmin_daily_2021_ncss.nc"))
ral_daymet <- daymet[[lubridate::yday("2021-07-23")]] |>
  cel_to_far() |>
  sp_subset()
```

## Measurement campaign

```{r}
campaign <- terra::rast("~/Data/rasters_chw_raleigh_durham_110821/am_t_f.tif")
ral_campaign <- sp_subset(campaign)
```

## gridMET

**Download gridMET**

```{r, eval = FALSE}
downloader::download(
  url = "http://www.northwestknowledge.net/metdata/data/tmmn_2021.nc",
  destfile = "~/Data/tmmn_2021.nc",
  mode = 'wb'
)
```

```{r}
gridmet <- terra::rast("~/Data/tmmn_2021.nc")
ral_gridmet <- sp_subset_gridmet(gridmet[[lubridate::yday("2021-07-23")]])
```

# Maps

## In degrees Fahrenheit

```{r}
r <- terra::project(ral_daymet, terra::crs(ral_campaign))
plot_daymet <- ggplot() +
    tidyterra::geom_spatraster(data = r) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders,
                                         terra::crs(ral_campaign))),
      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºF"),
      n.breaks = 12,
      limits = c(65.5, 71.5),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "Daymet product"
    ) +
  ylim(3954410, 3983480)+
  xlim(696840, 728440)+
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(1, "cm"),
      height = unit(0.30, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.2, "cm")
    ) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

plot_campaign <- ggplot() +
    tidyterra::geom_spatraster(data = ral_campaign) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders, terra::crs(ral_campaign))),
      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºF"),
      n.breaks = 12,
      limits = c(65.5, 71.5),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "Mobile measurement campaign"
    ) +
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(1, "cm"),
      height = unit(0.30, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.2, "cm")
    ) +
  ylim(3954410, 3983480)+
  xlim(696840, 728440)+
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

r <- cel_to_far(terra::project(ral_gridmet, terra::crs(ral_campaign)) - 273.15)
plot_gridmet <- ggplot() +
    tidyterra::geom_spatraster(data = r) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders, terra::crs(ral_campaign))),
                      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºF"),
      n.breaks = 12,
      limits = c(65.5, 71.5),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "gridMET product"
    ) +
  ylim(3954410, 3983480)+
  xlim(696840, 728440)+
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(1, "cm"),
      height = unit(0.30, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      pad_x = unit(0.2, "cm"),
      pad_y = unit(0.2, "cm")
    ) +
    theme(
      axis.text = element_text(size = 12),
      plot.caption = element_text(size = 10),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

```

Merge all maps 

```{r}
ggpubr::ggarrange(plot_gridmet,
                  plot_daymet,
                  plot_campaign,
                  ncol = 3,
                  legend = "right",
                  common.legend = TRUE)
```

## In degrees Celcius

```{r}
plot_daymet <- ggplot() +
    tidyterra::geom_spatraster(data = far_to_cel(terra::project(ral_daymet, terra::crs(ral_campaign)))) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders,
                                         terra::crs(ral_campaign))),
                      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºC"),
      n.breaks = 12,
      limits = c(18.6, 21.9),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "Daymet product",
      caption = expression(italic('Data source: daymet.ornl.gov'))
    ) +
  ylim(3954410, 3983480)+
  xlim(692960.2, 732000)+
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(.5, "cm"),
      height = unit(0.150, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      height = unit(1, "cm"),
      width = unit(1, "cm"),
      pad_x = unit(0.1, "cm"),
      pad_y = unit(0.1, "cm")
    ) +
    theme(
      axis.text = element_text(size = 8),
      axis.text.y = element_text(angle = 90),
      plot.caption = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      plot.title = element_text(size = 15, hjust = 0.5),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

plot_campaign <- ggplot() +
    tidyterra::geom_spatraster(data = far_to_cel(ral_campaign)) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders,
                                         terra::crs(ral_campaign))),
                      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºC"),
      n.breaks = 12,
      limits = c(18.6, 21.9),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "Mobile measurement campaign",
      caption = expression(italic(
        'Data source: climate.ncsu.edu/research/uhi/'))
    ) +
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(.5, "cm"),
      height = unit(0.150, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      height = unit(1, "cm"),
      width = unit(1, "cm"),
      pad_x = unit(0.1, "cm"),
      pad_y = unit(0.1, "cm")
    ) +
  ylim(3954410, 3983480)+
  xlim(692960.2, 732000)+
    theme(
      axis.text = element_text(size = 8),
      axis.text.y = element_text(angle = 90),
      plot.caption = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      plot.title = element_text(size = 15, hjust = 0.5),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )

plot_gridmet <- ggplot() +
    tidyterra::geom_spatraster(data = terra::project(ral_gridmet, terra::crs(ral_campaign)) - 273.15) +
    geom_sf(
      data = sf::st_as_sf(terra::project(ral_borders,
                                         terra::crs(ral_campaign))),
                      aes(geometry = geometry),
      colour = "black", linewidth = .3, fill = NA
    ) +
    tidyterra::scale_fill_whitebox_c(
      palette = "muted",
      labels = scales::label_number(suffix = "ºC"),
      n.breaks = 12,
      limits = c(18.6, 21.9),
      guide = guide_legend(reverse = TRUE)
    ) +
    labs(
      fill = "",
      title = "gridMET product",
      caption = expression(italic('Data source: climatologylab.org'))
    ) +
  ylim(3954410, 3983480)+
  xlim(692960.2, 732000)+
    ggspatial::annotation_scale(
      location = "bl", pad_x = unit(1, "cm"),
      pad_y = unit(.5, "cm"),
      height = unit(0.150, "cm"),
      text_cex = 1
    ) +
    ggspatial::annotation_north_arrow(
      location = "br",
      which_north = "true",
      height = unit(1, "cm"),
      width = unit(1, "cm"),
      pad_x = unit(0.1, "cm"),
      pad_y = unit(0.1, "cm")
    ) +
    theme(
      axis.text = element_text(size = 8),
      axis.text.y = element_text(angle = 90),
      plot.caption = element_text(size = 12),
      legend.text = element_text(size = 12),
      legend.title = element_text(size = 12),
      plot.title = element_text(size = 15, hjust = 0.5),
      panel.background = element_rect(fill = "white"),
      panel.grid.major = element_line(colour = "grey")
    )
```
Arrange the maps and save the figure

```{r}
maps <- ggpubr::ggarrange(plot_gridmet,
                          plot_daymet,
                          plot_campaign,
                          ncol = 3,
                          legend = "right",
                          common.legend = TRUE)
maps
ggsave(plot = maps,
       filename = "~/Pictures/air_temperature_products_raleigh_20210723.png",
       width = 12,
       height = 4,
       dpi = 200)
```

